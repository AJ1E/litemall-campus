# 用户故事 1.5: 个人主页

**Story ID**: 1.5  
**Epic**: Epic 1 - 用户认证与信用体系  
**优先级**: P0  
**预估工时**: 8 小时  
**创建日期**: 2025-10-27  
**创建者**: bmm-sm (Sprint Master)

---

## 📖 用户故事

**作为** 普通用户  
**我想要** 查看自己的发布商品、订单记录、收藏夹  
**以便** 便捷管理我的交易活动

---

## ✅ 验收标准

### 功能性要求

#### 1. 页面头部信息
- [ ] 显示用户头像（微信头像）
- [ ] 显示用户昵称
- [ ] 显示信用等级（使用 CreditBadge 组件）
- [ ] 显示总积分
- [ ] 显示成交笔数（已完成的订单数量）
- [ ] 显示学号认证状态（已认证/未认证）

#### 2. Tab 切换功能
- [ ] **Tab 1: 我的发布**
  - 子 Tab: 已上架 / 已下架
  - 显示商品列表（瀑布流布局）
  - 每个商品卡片显示：图片、标题、价格、浏览量
  - 支持操作：编辑、删除、重新上架/下架

- [ ] **Tab 2: 我的订单**
  - 子 Tab: 全部 / 待付款 / 待发货 / 待收货 / 已完成
  - 显示订单列表
  - 每个订单显示：商品图片、标题、价格、订单状态
  - 支持操作：取消订单、申请售后、确认收货、评价

- [ ] **Tab 3: 收藏夹**
  - 显示收藏的商品列表
  - 每个商品显示：图片、标题、价格、卖家信息
  - 支持操作：取消收藏、查看详情

#### 3. 交互要求
- [ ] 下拉刷新
- [ ] 上拉加载更多（分页）
- [ ] 商品卡片点击跳转到商品详情页
- [ ] 订单卡片点击跳转到订单详情页
- [ ] 点击头像/昵称可编辑个人资料

#### 4. 性能要求
- [ ] 页面首屏加载时间 < 1 秒
- [ ] 图片懒加载
- [ ] Tab 切换流畅（无卡顿）

---

## 🎨 UI 设计

### 页面布局

```
┌─────────────────────────────────────┐
│  ┌───┐  张同学  ⭐⭐⭐ 优秀         │
│  │头像│  学号已认证 ✓                │
│  └───┘  积分：350  成交：12 笔       │
├─────────────────────────────────────┤
│  [我的发布] [我的订单] [收藏夹]      │
├─────────────────────────────────────┤
│  [已上架] [已下架]                   │
├─────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐           │
│  │ 商品图片 │  │ 商品图片 │           │
│  │ 标题     │  │ 标题     │           │
│  │ ￥50    │  │ 已售罄   │           │
│  │ 浏览32次│  │         │           │
│  │ [编辑][删除] [重新上架]            │
│  └─────────┘  └─────────┘           │
│                                     │
│  ┌─────────┐  ┌─────────┐           │
│  │ 商品图片 │  │ 商品图片 │           │
│  └─────────┘  └─────────┘           │
└─────────────────────────────────────┘
```

### Tab 1: 我的发布 - 商品卡片

```
┌─────────────────────────┐
│  ┌─────────────┐        │
│  │  商品图片    │        │
│  └─────────────┘        │
│  高等数学A（第七版）    │
│  ￥50  浏览：32 次      │
│  [编辑] [删除] [下架]   │
└─────────────────────────┘
```

### Tab 2: 我的订单 - 订单卡片

```
┌─────────────────────────────────┐
│ 订单编号：202510271234           │
│ 2025-10-27 14:30                │
├─────────────────────────────────┤
│ [商品图] 高等数学A   ￥50        │
│ 卖家：李同学                     │
│ 状态：待付款                     │
├─────────────────────────────────┤
│         [取消订单] [去付款]      │
└─────────────────────────────────┘
```

### Tab 3: 收藏夹 - 商品卡片

```
┌─────────────────────────┐
│  ┌─────────────┐        │
│  │  商品图片    │        │
│  └─────────────┘        │
│  线性代数（第五版）      │
│  ￥30                   │
│  卖家：王同学 ⭐⭐       │
│  [取消收藏]             │
└─────────────────────────┘
```

---

## 🔌 API 接口设计

### 1. 获取用户基本信息

**接口**: `GET /wx/user/info`  
**权限**: 需要 JWT Token  

**响应**:
```json
{
  "errno": 0,
  "data": {
    "id": 123,
    "nickname": "张同学",
    "avatar": "https://...",
    "creditScore": 350,
    "creditLevel": "优秀",
    "authStatus": 1,
    "orderCount": 12,
    "studentNo": "202112345678"
  }
}
```

---

### 2. 获取我的发布列表

**接口**: `GET /wx/goods/myList`  
**权限**: 需要 JWT Token  

**请求参数**:
```
status=1         // 1-已上架, 0-已下架
page=1
limit=20
```

**响应**:
```json
{
  "errno": 0,
  "data": {
    "total": 50,
    "items": [
      {
        "id": 1,
        "picUrl": "https://...",
        "name": "高等数学A（第七版）上册",
        "retailPrice": 50,
        "viewCount": 32,
        "isOnSale": true,
        "createTime": "2025-10-20 14:30:00"
      }
    ]
  }
}
```

---

### 3. 获取我的订单列表

**接口**: `GET /wx/order/myList`  
**权限**: 需要 JWT Token  

**请求参数**:
```
status=0         // 0-全部, 201-待付款, 301-待发货, 401-待收货, 402-已完成
page=1
limit=20
```

**响应**:
```json
{
  "errno": 0,
  "data": {
    "total": 20,
    "items": [
      {
        "id": 1001,
        "orderSn": "202510271234",
        "orderStatus": 201,
        "orderStatusText": "待付款",
        "actualPrice": 50,
        "goodsList": [
          {
            "picUrl": "https://...",
            "goodsName": "高等数学A（第七版）上册",
            "price": 50
          }
        ],
        "addTime": "2025-10-27 14:30:00",
        "canCancel": true,
        "canPay": true,
        "canConfirm": false,
        "canComment": false
      }
    ]
  }
}
```

---

### 4. 获取收藏夹列表

**接口**: `GET /wx/collect/list`  
**权限**: 需要 JWT Token  

**请求参数**:
```
page=1
limit=20
```

**响应**:
```json
{
  "errno": 0,
  "data": {
    "total": 15,
    "items": [
      {
        "id": 1,
        "goodsId": 123,
        "picUrl": "https://...",
        "name": "线性代数（第五版）",
        "retailPrice": 30,
        "sellerName": "王同学",
        "sellerCreditLevel": "良好",
        "addTime": "2025-10-25 10:00:00"
      }
    ]
  }
}
```

---

### 5. 商品操作接口

#### 5.1 编辑商品
**接口**: `POST /wx/goods/update`  
**权限**: 需要 JWT Token  

**请求体**:
```json
{
  "id": 1,
  "name": "高等数学A（第七版）上册",
  "retailPrice": 45,
  "brief": "八五折转让"
}
```

#### 5.2 删除商品
**接口**: `POST /wx/goods/delete`  
**请求**: `{"id": 1}`

#### 5.3 上架/下架商品
**接口**: `POST /wx/goods/toggleOnSale`  
**请求**: `{"id": 1, "isOnSale": true}`

---

### 6. 订单操作接口

#### 6.1 取消订单
**接口**: `POST /wx/order/cancel`  
**请求**: `{"orderId": 1001}`

#### 6.2 申请售后
**接口**: `POST /wx/aftersale/submit`  
**请求**:
```json
{
  "orderId": 1001,
  "type": 1,
  "reason": "商品与描述不符",
  "pictures": ["https://..."]
}
```

---

## 📦 前端页面结构

### 文件列表

```
litemall-wx/pages/user/
├── user.js              // 个人主页主文件
├── user.wxml            // 页面结构
├── user.wxss            // 页面样式
└── user.json            // 页面配置

litemall-wx/components/
├── goods-card/          // 商品卡片组件（复用）
│   ├── goods-card.js
│   ├── goods-card.wxml
│   └── goods-card.wxss
└── order-card/          // 订单卡片组件（复用）
    ├── order-card.js
    ├── order-card.wxml
    └── order-card.wxss
```

---

## 🎯 业务逻辑

### 商品操作权限规则

| 操作 | 条件 | 说明 |
|-----|------|------|
| 编辑 | 商品未售出 | 已售出商品不可编辑 |
| 删除 | 商品未售出 | 已售出商品不可删除 |
| 下架 | 商品已上架 | 下架后不在首页展示 |
| 重新上架 | 商品已下架 | 重新上架后恢复展示 |

### 订单操作权限规则

| 操作 | 订单状态 | 说明 |
|-----|---------|------|
| 取消订单 | 待付款、待发货 | 已发货后不可取消 |
| 付款 | 待付款 | 超时未付款自动取消 |
| 确认收货 | 待收货 | 确认后订单完成，卖家获得积分 |
| 申请售后 | 已完成（7天内）| 超过7天不可申请 |
| 评价 | 已完成（未评价）| 每个订单只能评价一次 |

---

## 🧪 测试用例

### 测试用例 1: 查看我的发布
**前置条件**: 用户已发布 3 个商品（2 个已上架，1 个已下架）  
**操作步骤**:
1. 进入个人主页
2. 点击"我的发布"
3. 默认显示"已上架"

**预期结果**:
- 显示 2 个已上架商品
- 点击"已下架"切换，显示 1 个已下架商品

---

### 测试用例 2: 编辑商品
**前置条件**: 用户有 1 个已上架且未售出的商品  
**操作步骤**:
1. 点击商品卡片的"编辑"按钮
2. 修改价格：50 → 45
3. 点击保存

**预期结果**:
- 价格更新为 45 元
- 商品列表刷新，显示新价格

---

### 测试用例 3: 删除已售出商品
**前置条件**: 用户有 1 个已售出的商品  
**操作步骤**:
1. 点击商品卡片的"删除"按钮

**预期结果**:
- 提示"已售出商品不可删除"
- 删除操作失败

---

### 测试用例 4: 取消待付款订单
**前置条件**: 用户有 1 个待付款订单  
**操作步骤**:
1. 进入"我的订单"
2. 点击"取消订单"
3. 确认取消

**预期结果**:
- 订单状态变更为"已取消"
- 用户积分扣除 5 分（如果付款后 5 分钟后取消）

---

### 测试用例 5: 收藏夹取消收藏
**前置条件**: 用户收藏了 5 个商品  
**操作步骤**:
1. 进入"收藏夹"
2. 点击某个商品的"取消收藏"

**预期结果**:
- 该商品从收藏夹移除
- 总数变为 4

---

## 🔗 依赖关系

### 前置依赖
- Story 1.1: 微信一键登录（需要 userId 和 JWT）
- Story 1.4: 信用等级展示（使用 CreditBadge 组件）
- litemall 现有功能：商品管理、订单管理、收藏功能

### 复用的 litemall 接口
- `GET /wx/user/info` - 用户信息（可能需扩展字段）
- `GET /wx/goods/list` - 商品列表（需过滤当前用户）
- `GET /wx/order/list` - 订单列表（需过滤当前用户）
- `GET /wx/collect/list` - 收藏列表

### 新增接口
- `GET /wx/goods/myList` - 我的发布列表
- `POST /wx/goods/toggleOnSale` - 上架/下架

---

## 📈 性能优化

### 1. 图片懒加载
```javascript
// 使用小程序内置懒加载
<image lazy-load="{{true}}" src="{{item.picUrl}}" />
```

### 2. 分页加载
```javascript
onReachBottom: function() {
  if (this.data.page * this.data.limit < this.data.total) {
    this.setData({ page: this.data.page + 1 });
    this.loadGoodsList();
  }
}
```

### 3. Tab 数据缓存
```javascript
// 切换 Tab 时缓存已加载的数据
data: {
  goodsListCache: {},
  orderListCache: {}
}
```

---

## 📝 Definition of Done (DoD)

- [ ] 页面头部正确显示用户信息（头像、昵称、积分、成交笔数）
- [ ] 3 个 Tab 切换正常
- [ ] "我的发布"支持上架/下架/编辑/删除
- [ ] "我的订单"支持取消/申请售后/确认收货
- [ ] "收藏夹"支持取消收藏
- [ ] 下拉刷新和上拉加载正常
- [ ] 图片懒加载生效
- [ ] 单元测试覆盖率 ≥ 70%
- [ ] UI 与设计稿一致
- [ ] 代码 Review 通过
- [ ] 已部署到测试环境并验证

---

## 🎨 设计规范

### 间距
- 顶部用户信息区高度：120rpx
- Tab 栏高度：80rpx
- 商品卡片间距：20rpx
- 左右边距：30rpx

### 颜色
```css
--color-primary: #FF6B6B;      /* 主题色 */
--color-text-primary: #333333; /* 主文本 */
--color-text-secondary: #999999; /* 次要文本 */
--color-border: #EEEEEE;       /* 边框 */
--color-background: #F5F5F5;   /* 背景 */
```

---

**状态**: 待开发  
**负责人**: 待分配  
**开始日期**: 待定  
**完成日期**: 待定
