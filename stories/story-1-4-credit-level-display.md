# 用户故事 1.4: 信用等级展示

**Story ID**: 1.4  
**Epic**: Epic 1 - 用户认证与信用体系  
**优先级**: P0  
**预估工时**: 8 小时  
**创建日期**: 2025-10-27  
**创建者**: bmm-sm (Sprint Master)

---

## 📖 用户故事

**作为** 普通用户  
**我想要** 在个人主页和商品详情页看到卖家的信用等级  
**以便** 判断交易对象的可信度

---

## ✅ 验收标准

### 功能性要求

#### 1. 信用等级定义
- [ ] **⭐ 新手**（0-100 分）
  - 灰色星标 (#999999)
  - 无特殊徽章
  - 显示文字："新手"

- [ ] **⭐⭐ 良好**（101-300 分）
  - 蓝色星标 (#1890FF)
  - 无特殊徽章
  - 显示文字："良好"

- [ ] **⭐⭐⭐ 优秀**（301-500 分）
  - 金色星标 (#FAAD14)
  - 无特殊徽章
  - 显示文字："优秀"

- [ ] **⭐⭐⭐⭐ 信誉商家**（501-1000 分）
  - 红色星标 (#F5222D)
  - 带认证徽章 🏆
  - 显示文字："信誉商家"

#### 2. 展示位置
- [ ] **个人主页**：头像右侧显示星标 + 等级名称 + 积分
- [ ] **商品详情页**：卖家信息区显示星标 + 等级名称
- [ ] **用户列表页**（如快递员列表）：每个用户卡片显示星标

#### 3. 交互要求
- [ ] 点击星标弹出积分详情弹窗
- [ ] 弹窗显示内容：
  - 总积分
  - 本月获得积分
  - 本月扣除积分
  - 查看详细历史（跳转到积分历史页面）

#### 4. 性能要求
- [ ] 星标组件首次渲染时间 < 50ms
- [ ] 支持缓存（Redis），减少数据库查询

---

## 🎨 UI 设计

### 个人主页展示

```
┌─────────────────────────────────────┐
│  头像   昵称  ⭐⭐⭐ 优秀 (350分)     │
│         学号已认证 ✓                 │
├─────────────────────────────────────┤
│  [我的发布] [我的订单] [收藏夹]      │
└─────────────────────────────────────┘
```

### 商品详情页展示

```
┌─────────────────────────────────────┐
│  商品图片轮播                        │
├─────────────────────────────────────┤
│  ￥50  高等数学A（第七版）上册       │
│  卖家：张同学  ⭐⭐ 良好             │
│  （点击查看信用详情）                │
└─────────────────────────────────────┘
```

### 积分详情弹窗

```
┌─────────────────────────────────────┐
│         信用积分详情                 │
├─────────────────────────────────────┤
│  当前等级：⭐⭐⭐ 优秀               │
│  总积分：350 分                      │
│  本月获得：+50 分                    │
│  本月扣除：-10 分                    │
├─────────────────────────────────────┤
│  距离下一等级还需：151 分            │
│  (升至"信誉商家"需 501 分)           │
├─────────────────────────────────────┤
│  [查看详细历史]   [关闭]             │
└─────────────────────────────────────┘
```

---

## 🔌 API 接口设计

### 1. 查询用户信用详情

**接口**: `GET /wx/user/creditDetail`  
**权限**: 需要 JWT Token  

**请求参数**:
```
userId=123  // 可选，不传则查询当前登录用户
```

**响应**:
```json
{
  "errno": 0,
  "data": {
    "userId": 123,
    "creditScore": 350,
    "level": "优秀",
    "levelCode": 3,
    "levelIcon": "⭐⭐⭐",
    "levelColor": "#FAAD14",
    "minScore": 301,
    "maxScore": 500,
    "monthGain": 50,        // 本月获得积分
    "monthLoss": 10,        // 本月扣除积分
    "nextLevelScore": 501,  // 下一等级所需积分
    "nextLevelName": "信誉商家"
  }
}
```

---

### 2. 批量查询用户信用等级（用于列表页）

**接口**: `POST /wx/user/batchCreditLevel`  
**权限**: 需要 JWT Token  

**请求体**:
```json
{
  "userIds": [1, 2, 3, 4, 5]
}
```

**响应**:
```json
{
  "errno": 0,
  "data": {
    "1": {
      "creditScore": 350,
      "level": "优秀",
      "levelIcon": "⭐⭐⭐",
      "levelColor": "#FAAD14"
    },
    "2": {
      "creditScore": 80,
      "level": "新手",
      "levelIcon": "⭐",
      "levelColor": "#999999"
    }
  }
}
```

---

## 📦 前端组件设计

### CreditBadge 组件

**文件**: `litemall-wx/components/credit-badge/credit-badge.wxml`

**属性**:
```javascript
{
  userId: Number,      // 用户ID
  score: Number,       // 积分（可选，传入则不查询接口）
  level: Number,       // 等级（可选，传入则不查询接口）
  showDetail: Boolean, // 是否可点击查看详情（默认 true）
  size: String         // 尺寸：small/medium/large（默认 medium）
}
```

**使用示例**:
```xml
<!-- 在商品详情页 -->
<credit-badge userId="{{goods.userId}}" size="small" />

<!-- 在个人主页 -->
<credit-badge userId="{{userInfo.id}}" size="large" showDetail="{{true}}" />
```

**渲染效果**:
```xml
<view class="credit-badge" bindtap="showDetail">
  <text class="stars" style="color: {{levelColor}}">{{levelIcon}}</text>
  <text class="level-name">{{levelName}}</text>
  <text class="score">({{score}}分)</text>
</view>
```

---

## 🗄️ 数据库设计

### 积分统计视图（可选优化）

为了快速查询"本月获得/扣除"积分，可以创建视图：

```sql
CREATE VIEW v_user_month_credit_stats AS
SELECT 
  user_id,
  SUM(CASE WHEN score_change > 0 THEN score_change ELSE 0 END) AS month_gain,
  ABS(SUM(CASE WHEN score_change < 0 THEN score_change ELSE 0 END)) AS month_loss
FROM sicau_credit_log
WHERE create_time >= DATE_FORMAT(NOW(), '%Y-%m-01 00:00:00')
GROUP BY user_id;
```

---

## 🎯 业务逻辑

### 等级计算规则

| 积分范围 | 等级 | 星标数 | 颜色 | 特殊标识 |
|---------|------|--------|------|---------|
| 0-100 | 新手 | ⭐ | #999999 | 无 |
| 101-300 | 良好 | ⭐⭐ | #1890FF | 无 |
| 301-500 | 优秀 | ⭐⭐⭐ | #FAAD14 | 无 |
| 501-1000 | 信誉商家 | ⭐⭐⭐⭐ | #F5222D | 🏆 徽章 |

### 积分详情弹窗逻辑

1. 用户点击星标
2. 调用 `GET /wx/user/creditDetail?userId=123`
3. 显示弹窗，展示：
   - 当前等级和积分
   - 本月获得/扣除（从 `sicau_credit_log` 表统计）
   - 距离下一等级差距（nextLevelScore - currentScore）
4. 点击"查看详细历史"跳转到积分历史页面

---

## 🧪 测试用例

### 测试用例 1: 新手等级展示
**前置条件**: 用户积分 50 分  
**操作步骤**: 进入个人主页  
**预期结果**:
- 显示 1 个灰色星标 ⭐
- 显示文字"新手 (50分)"

---

### 测试用例 2: 信誉商家等级展示
**前置条件**: 用户积分 550 分  
**操作步骤**: 进入个人主页  
**预期结果**:
- 显示 4 个红色星标 ⭐⭐⭐⭐
- 显示文字"信誉商家 (550分)"
- 显示 🏆 认证徽章

---

### 测试用例 3: 积分详情弹窗
**前置条件**: 用户积分 350 分，本月获得 50 分，扣除 10 分  
**操作步骤**:
1. 点击星标
2. 查看弹窗内容

**预期结果**:
- 总积分：350 分
- 本月获得：+50 分
- 本月扣除：-10 分
- 距离下一等级（信誉商家）还需：151 分

---

### 测试用例 4: 批量查询性能测试
**前置条件**: 商品列表有 20 个不同卖家  
**操作步骤**: 调用批量查询接口  
**预期结果**:
- 响应时间 < 100ms
- 返回 20 个用户的等级信息

---

## 📈 性能优化

### 1. Redis 缓存策略

```
Key: credit_level:{userId}
Value: {"score": 350, "level": 3, "levelName": "优秀", "levelColor": "#FAAD14"}
TTL: 300 秒（5 分钟）
```

**缓存更新时机**:
- 积分变动时主动更新缓存
- 缓存过期后从数据库重新加载

### 2. 前端缓存

```javascript
// 在 app.js 中缓存当前用户信用等级
globalData: {
  userCreditLevel: null
}
```

---

## 🔗 依赖关系

### 前置依赖
- Story 1.1: 微信一键登录（需要 userId）
- Story 1.3: 信用积分计算（需要 credit_score 字段和计算逻辑）

### 影响范围
- Story 1.5: 个人主页（会使用 CreditBadge 组件）
- Epic 2: 商品发布与管理（商品详情页显示卖家等级）
- Epic 6: 学生快递配送（快递员列表显示信用等级）

---

## 📝 Definition of Done (DoD)

- [ ] CreditBadge 组件已创建并通过测试
- [ ] API 接口 `creditDetail` 和 `batchCreditLevel` 已实现
- [ ] 在个人主页、商品详情页正确展示信用等级
- [ ] 积分详情弹窗功能正常
- [ ] 本月获得/扣除积分统计准确
- [ ] Redis 缓存已配置并生效
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] UI 与设计稿一致
- [ ] 代码 Review 通过
- [ ] 已部署到测试环境并验证

---

## 🎨 设计资源

### 星标图标（Unicode）
- ⭐ - U+2B50（彩色星）
- ★ - U+2605（实心星）
- ☆ - U+2606（空心星）

### 颜色规范
```css
--color-newbie: #999999;      /* 新手 - 灰色 */
--color-good: #1890FF;         /* 良好 - 蓝色 */
--color-excellent: #FAAD14;    /* 优秀 - 金色 */
--color-trusted: #F5222D;      /* 信誉商家 - 红色 */
```

---

## 📊 数据统计需求

### 管理后台需展示
- 各等级用户数量分布（饼图）
- 本月升级用户数量（折线图）
- 平均积分变化趋势

---

**状态**: 待开发  
**负责人**: 待分配  
**开始日期**: 待定  
**完成日期**: 待定
